name: CI with secrets

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      # CI secrets (set these in repository Settings -> Secrets and variables -> Actions)
      ENCRYPTION_KEY_B64: ${{ secrets.ENCRYPTION_KEY_B64 }}
      SALT_B64: ${{ secrets.SALT_B64 }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
      OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Decode secrets to files (ephemeral)
        run: |
          set -euo pipefail
          # If your app reads key files, decode the base64 secrets into files with strict perms
          if [ -n "${ENCRYPTION_KEY_B64:-}" ]; then
            echo "$ENCRYPTION_KEY_B64" | base64 --decode > .encryption_key
            chmod 600 .encryption_key
          fi
          if [ -n "${SALT_B64:-}" ]; then
            echo "$SALT_B64" | base64 --decode > .salt
            chmod 600 .salt
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest -q

      - name: Cleanup secrets
        if: always()
        run: |
          # Attempt secure deletion; fall back to rm
          command -v shred >/dev/null 2>&1 && shred -u .encryption_key .salt || rm -f .encryption_key .salt || true
